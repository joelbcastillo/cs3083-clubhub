USE clubhub;

CREATE TABLE Person (
	pid VARCHAR(30) PRIMARY KEY NOT NULL,
	passwd CHAR(32) NOT NULL,
	fname VARCHAR(32),
	lname VARCHAR(32),
	email VARCHAR(64),
	role ENUM('student', 'advisor') NOT NULL
);

CREATE TABLE Advisor (
	aid VARCHAR(30) NOT NULL,
	phone CHAR(12),
	FOREIGN KEY(aid) REFERENCES Person(pid)
);

CREATE TABLE Student (
	sid VARCHAR(30) NOT NULL,
	gender ENUM('M', 'F', 'O'),
	class VARCHAR(30),
	FOREIGN KEY(sid) REFERENCES Person(pid)
);

CREATE TABLE Club (
	cid INT PRIMARY KEY NOT NULL,
	cname VARCHAR(32),
	description VARCHAR(512),
	aid VARCHAR(30) NOT NULL,
	FOREIGN KEY(aid) REFERENCES Advisor(aid)
);

CREATE TABLE `Event` (
	eid INT PRIMARY KEY NOT NULL,
	ename VARCHAR(32),
	description VARCHAR(512), 
	datetime DATETIME,
	location VARCHAR(512),
	isPublic BOOLEAN
);

CREATE TABLE Keyword (
	kid INT PRIMARY KEY NOT NULL,
	topic VARCHAR(32)
);
CREATE TABLE Comment (
	comment_id INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
	comment VARCHAR(512),
	pid VARCHAR(30),
	cid INT,
	eid INT,
	isPublic BOOLEAN REFERENCES `Event`(isPublic),
	FOREIGN KEY(pid) REFERENCES Person(pid),
	FOREIGN KEY(cid) REFERENCES Club(cid),
	FOREIGN KEY(eid) REFERENCES `Event`(eid)
);

CREATE TABLE Membership (
	sid VARCHAR(30) NOT NULL,
	cid INT NOT NULL,
	role ENUM('member','president','teasurer'),
	PRIMARY KEY(sid, cid),
	FOREIGN KEY(sid) REFERENCES Student(sid),
	FOREIGN KEY(cid) REFERENCES Club(cid)
);	

CREATE TABLE Sponsors (
	eid INT NOT NULL,
	cid INT NOT NULL,
	PRIMARY KEY(eid, cid),
	FOREIGN KEY(eid) REFERENCES `Event`(eid),
	FOREIGN KEY(cid) REFERENCES Comment(cid)
);

CREATE TABLE Event_Attendees (
	pid VARCHAR(30) NOT NULL,
	eid INT NOT NULL,
	FOREIGN KEY(eid) REFERENCES `Event`(eid),
	FOREIGN KEY(pid) REFERENCES Person(pid),
	PRIMARY KEY(pid, eid)
);

CREATE TABLE Interests (
	pid VARCHAR(30) NOT NULL,
	kid INT NOT NULL,
	FOREIGN KEY(pid) REFERENCES Person(pid),
	FOREIGN KEY(kid) REFERENCES Keyword(kid),
	PRIMARY KEY(pid,kid)
);

CREATE TABLE Club_Topics (
	cid INT NOT NULL,
	kid INT NOT NULL,
	FOREIGN KEY(cid) REFERENCES Club(cid),
	FOREIGN KEY(kid) REFERENCES Keyword(kid),
	PRIMARY KEY(cid,kid)
);

show WARNINGS ;


#  3 INSERT STATEMENTS

# (a)
INSERT INTO Club VALUES(1,'Frisbee Club', 'Toss aerodynamics disks!', 'Ann');
INSERT INTO Club VALUES(2,'Theater Club', 'Time to Perform!', 'Bob');

# (b)
INSERT INTO Person VALUES('Pedro', MD5('Pedro'), 'Pedro', 'Pedro', 'Pedro@email.com', 'Student');
INSERT INTO Person VALUES('Phil', MD5('Phil'), 'Phil', 'Phil', 'Pedro@email.com', 'Student');
INSERT INTO Person VALUES ('Ann', md5('Ann'), 'Ann', 'Ann', 'Ann@email.com', 'Student');
INSERT INTO Person VALUES ('Bob', md5('Bob'), 'Bob', 'Bob', 'Bob@email.com', 'Student');
INSERT INTO Membership VALUES('Pedro',1, 'Member');
INSERT INTO Membership VALUES('Pedro',2, 'President');
INSERT INTO Membership VALUES('Phil',1, 'President');

# (c)
INSERT INTO Keyword VALUES (1, 'Sports');
INSERT INTO Keyword VALUES (2, 'Acting');
INSERT INTO Keyword VALUES (3, 'Singing');

INSERT INTO Club_Topics VALUES (2, 2);
INSERT INTO Club_Topics VALUES (2, 3);
INSERT INTO Club_Topics VALUES (1, 1);

INSERT INTO Interests VALUES ((SELECT pid FROM Person WHERE person.fname = 'Pedro'), 2);
INSERT INTO Interests VALUES ((SELECT pid FROM Person WHERE person.fname = 'Pedro'), 1);
INSERT INTO Interests VALUES ((SELECT pid FROM Person WHERE person.fname = 'Ann'), 3);

# (d)
INSERT INTO Event VALUES(1, 'Tossing Competition', 'Fun', '2015-03-15 12:00:00', 'Central Park', TRUE);
INSERT INTO Event VALUES(2, 'Comedy', 'Fun', '2015-03-28 19:00:00', 'NYU', FALSE);
INSERT INTO Event VALUES(3, 'Drama', 'Fun', '2015-03-20 19:00:00', 'Princeton', TRUE);
INSERT INTO Sponsors VALUES(1,1);
INSERT INTO Sponsors VALUES(2,2);
INSERT INTO Sponsors VALUES(3,2);

# (e)
INSERT INTO Event_Attendees VALUES('Pedro', 2);
INSERT INTO Event_Attendees VALUES('Pedro', 1);
INSERT INTO Event_Attendees VALUES('PHil', 1);
INSERT INTO Event_Attendees VALUES('PHil', 3);

# (f)
INSERT INTO Comment (comment, pid, cid, eid, isPublic) VALUES ('Amazing Club', 'Pedro', 2, 2, FALSE);
INSERT INTO Comment (comment, pid, cid, eid, isPublic) VALUES ('Gets better!', 'Pedro', 2, 2, TRUE);
INSERT INTO Comment (comment, pid, cid, eid, isPublic) VALUES ('Fun!', 'Phil', 1, 2, FALSE);
-- #4
-- (a)
select pid, passwd
from Person
where pid = 'Pedro' and passwd = MD5('Pedro')

-- (b)
SELECT eid, title, datetime FROM Event, Event_Attendees, Person WHERE Event.eid = Event_Attendees.eid AND Event_Attendees.pid = Person.pid AND Person.name = 'Pedro' AND Event.datetime BETWEEN (CURDATE() AND DATE_ADD(CURDATE(), INTERVAL 7 DAY); 

-- (c)
select M.cid
from Membership as M, Student as S
where M.sid = S.sid and S.sid = 'Pedro'

-- (d)
select E.eid, P.fname, P.lname, count(P.pid) as num
from Event as E, Person as P, Event_Attendees as EA, Sponsors as S
where P.pid = EA.pid and S.cid = '2'
group by Event

-- (e)
select case when exists (
	select *
	from Event as E, Membership as M, Club as C
	where E.eid = 'E3'or (M.sid = 'Pedro' and M.cid = C.cid)
)
then cast(1 as bit)
else cast(0 as bit) end
