-- Munieshwar Ramdass; Joel Castillo
-- Professor Phillis Frankl
-- CS-UY 3982
-- 6 March 2015
			-- Project Part 2

-- #2 CREATE TABLE STATEMENTS

CREATE TABLE Person (
	pid VARCHAR(30) PRIMARY KEY NOT NULL,
	passwd CHAR(32) NOT NULL,
	fname VARCHAR(32),
	lname VARCHAR(32),
	email VARCHAR(64),
	role ENUM('student', 'advisor') NOT NULL
);

CREATE TABLE Advisor (
	aid VARCHAR(30) NOT NULL,
	phone CHAR(12),
	FOREIGN KEY(aid) REFERENCES Person(pid)
);

CREATE TABLE Student (
	sid VARCHAR(30) NOT NULL,
	gender ENUM('M', 'F', 'O'),
	class VARCHAR(30),
	FOREIGN KEY(sid) REFERENCES Person(pid)
);

CREATE TABLE Club (
	cid INT PRIMARY KEY NOT NULL,
	cname VARCHAR(32),
	description VARCHAR(512),
	aid VARCHAR(30) NOT NULL,
	FOREIGN KEY(aid) REFERENCES Advisor(aid)
);

CREATE TABLE Event (
	eid INT PRIMARY KEY NOT NULL,
	ename VARCHAR(32),
	description VARCHAR(512), 
	datetime DATETIME,
	location VARCHAR(512),
	public BOOLEAN DEFAULT FALSE
);

CREATE TABLE Keyword (
	kid INT PRIMARY KEY NOT NULL,
	topic VARCHAR(32)
);

CREATE TABLE Comment (
	comment_id INT PRIMARY KEY NOT NULL,
	comment VARCHAR(512),
	pid INT,
	cid INT,
	eid INT,
	public BOOLEAN DEFAULT FALSE,
	FOREIGN KEY(pid) REFERENCES Person(id),
	FOREIGN KEY(cid) REFERENCES Club(id),
	FOREIGN KEY(eid) REFERENCES Event(id),
	FOREIGN KEY(public) REFERENCES Event(public)
);

CREATE TABLE Membership (
	sid VARCHAR(30) NOT NULL,
	cid INT NOT NULL,
	role ENUM('member','president','teasurer'), -- What are possible roles? There's 3
	PRIMARY KEY(sid, cid),
	FOREIGN KEY(sid) REFERENCES Student(sid),
	FOREIGN KEY(cid) REFERENCES Club(cid)
);	

CREATE TABLE Sponsors (
	eid INT NOT NULL,
	cid INT NOT NULL,
	PRIMARY KEY(eid, cid),
	FOREIGN KEY(eid) REFERENCES Event(eid),
	FOREIGN KEY(cid) REFERENCES Comment(cid)
);

CREATE TABLE Event_Attendees (
	pid VARCHAR(30) NOT NULL,
	eid VARCHAR(30) NOT NULL,
	PRIMARY KEY(pid, eid),
	FOREIGN KEY(pid) REFERENCES Person(pid),
	FOREIGN KEY(eid) REFERENCES Event(eid)
);


-- #3 INSERT STATEMENTS

-- (a)
insert into Club
values('1','Frisbee Club', 'Toss aerodynamics disks!', 'Ann');
insert into Club
values('2','Theater Club', 'Time to Perform!', 'Bob');


-- (b)
INSERT INTO Person
VALUES('Pedro', MD5('Pedro'), 'Pedro', 'Pedro', 'Pedro@email.com')
INSERT INTO Person
VALUES('Phil', MD5('Phil'), 'Phil', 'Phil', 'Pedro@email.com')
INSERT INTO Person
VALUES ('Ann', md5('Ann'), 'Ann', 'Ann', 'Ann@email.com')
INSERT INTO Person
VALUES ('Bob', md5('Bob'), 'Bob', 'Bob', 'Bob@email.com')
INSERT INTO Membership
VALUES('Pedro','1', member)
INSERT INTO Membership
VALUES('Pedro','2', president)
INSERT INTO Membership
VALUES('Phil','1', president)

-- (c)
-- How do you reprsent this relationship?

-- (d)
INSERT INTO Event
VALUES('E1', 'Tossing Competition', 'Fun', 'March 30th, 2015', 'Central Park', TRUE)
INSERT INTO Event
VALUES('E2', 'Comedy', 'Fun', 'March 28th, 2015', 'NYU', FALSE)
INSERT INTO Event
VALUES('E3', 'Drama', 'Fun', 'March 20th, 2015', 'Princeton', TRUE)
-- CHECK DATETIME SYNTAX
INSERT INTO Sponsors
VALUES('E1','1')
INSERT INTO Sponsors
VALUES('E2','2')
INSERT INTO Sponsors
VALUES('E3','2')

-- (e)
INSERT INTO Event_Attendees
VALUES('E2', 'Pedro')
INSERT INTO Event_Attendees
VALUES('E1', 'Pedro')
INSERT INTO Event_Attendees
VALUES('E1', 'PHil')
INSERT INTO Event_Attendees
VALUES('E3', 'PHil')

-- (f)
INSERT INTO Comment
VALUES('1', 'Amazing Club', 'Pedro', '2', 'E2', FALSE)
INSERT INTO Comment
VALUES('2', 'Gets better!', 'Pedro', '2', 'E2', TRUE)
INSERT INTO Comment
VALUES('1', 'Fun!', '1', 'Phil', 'E2', FALSE)

-- (g) and (h) ADMINISTRATIVE

-- #4
-- (a)
select pid, passwd
from Person
where pid = 'Pedro' and passwd = MD5('Pedro')

-- (b) STALKING PEDRO FOR THE NEXT 7 DAYS
-- HOW YOU DO THIS?

-- (c)
select M.cid
from Membership as M, Student as S
where M.sid = S.sid and S.sid = 'Pedro'

-- (d)
select E.eid, P.fname, P.lname, count(P.pid) as num
from Event as E, Person as P, Event_Attendees as EA, Sponsors as S
where P.pid = EA.pid and S.cid = '2'
group by Event

-- (e)
select case when exists (
	select *
	from Event as E, Membership as M, Club as C
	where E.eid = 'E3'or (M.sid = 'Pedro' and M.cid = C.cid)
)
then cast(1 as bit)
else cast(0 as bit) end